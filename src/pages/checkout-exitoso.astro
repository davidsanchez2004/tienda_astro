---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabaseAdminClient } from '../lib/supabase';
import { stripe, isStripeConfigured } from '../lib/stripe';
import { sendEmailWithGmail } from '../lib/gmail-transporter';
import { generateOrderConfirmationCustomer, generateOrderNotificationAdmin, generateDiscountCodeEmail } from '../lib/email-templates-byarena';

const { searchParams } = new URL(Astro.request.url);
const sessionId = searchParams.get('session_id');
const orderId = searchParams.get('order');

let paymentVerified = false;
let orderData = null;
let error = null;
let emailSent = false;

// Email del admin hardcodeado
const ADMIN_EMAIL = 'davidsanchezacosta0@gmail.com';

// Verificar el pago real con Stripe
if (sessionId && isStripeConfigured()) {
  try {
    console.log('Checkout-exitoso - Verificando sesi√≥n:', sessionId);
    const session = await stripe.checkout.sessions.retrieve(sessionId);
    console.log('Checkout-exitoso - Estado de pago:', session.payment_status);
    
    if (session.payment_status === 'paid') {
      paymentVerified = true;
      
      // Actualizar orden como pagada si existe
      if (orderId) {
        console.log('Checkout-exitoso - Actualizando orden:', orderId);
        const { data, error: updateError } = await supabaseAdminClient
          .from('orders')
          .update({ 
            status: 'paid', 
            payment_status: 'paid',
            stripe_payment_intent_id: session.payment_intent,
            updated_at: new Date().toISOString()
          })
          .eq('id', orderId)
          .select()
          .single();
        
        if (!updateError && data) {
          orderData = data;
          console.log('Checkout-exitoso - Orden actualizada, user_id:', data.user_id);
          
          // Enviar email de confirmaci√≥n
          try {
            console.log('Checkout-exitoso - Enviando email a:', data.guest_email);
            // Obtener items del pedido
            const { data: orderItems } = await supabaseAdminClient
              .from('order_items')
              .select('*, products(name)')
              .eq('order_id', orderId);
            
            const customerEmail = data.guest_email;
            const customerName = data.guest_first_name 
              ? `${data.guest_first_name} ${data.guest_last_name || ''}`.trim()
              : 'Cliente';
            
            if (customerEmail) {
              const items = (orderItems || []).map((item: any) => ({
                  name: item.products?.name || 'Producto',
                  quantity: item.quantity,
                  price: item.price,
                }));
                
                const emailData = {
                  orderId: data.id,
                  orderNumber: data.id.slice(0, 8).toUpperCase(),
                  customerName,
                  customerEmail,
                  items,
                  subtotal: data.subtotal || data.total,
                  shippingCost: data.shipping_cost || 0,
                  discount: data.discount_amount || 0,
                  total: data.total,
                  shippingAddress: data.shipping_address || {},
                  shippingMethod: data.shipping_option as 'home' | 'pickup',
                };
                
                // Enviar email al cliente
                const customerEmailHtml = generateOrderConfirmationCustomer(emailData);
                await sendEmailWithGmail({
                  to: customerEmail,
                  subject: `¬°Gracias por tu pedido! #${emailData.orderNumber} - BY ARENA`,
                  html: customerEmailHtml,
                });
                
                // Enviar email al admin
                const adminEmailHtml = generateOrderNotificationAdmin(emailData);
                await sendEmailWithGmail({
                  to: ADMIN_EMAIL,
                  subject: `Nuevo pedido #${emailData.orderNumber} de ${customerName}`,
                  html: adminEmailHtml,
                });
                
                emailSent = true;
                console.log('Confirmation emails sent for order:', orderId);
              }
            } catch (emailError) {
              console.error('Error sending confirmation email:', emailError);
            }

            // ===== VERIFICAR CUPONES AUTOM√ÅTICOS =====
            try {
              const guestEmail = data.guest_email;
              if (guestEmail) {
                console.log('[AutoCoupon-Checkout] Checking auto coupons for:', guestEmail);
                
                let generatedCoupons: any[] = [];
                
                if (data.user_id) {
                  // Usuario registrado: usar RPC
                  const { data: rpcResult, error: rpcError } = await supabaseAdminClient
                    .rpc('check_auto_coupons_for_user', {
                      p_user_id: data.user_id,
                      p_user_email: guestEmail,
                    });
                  if (!rpcError && rpcResult) {
                    generatedCoupons = rpcResult;
                  }
                } else {
                  // Invitado: calcular gasto total por email
                  const { data: orderTotals } = await supabaseAdminClient
                    .from('orders')
                    .select('total')
                    .ilike('guest_email', guestEmail)
                    .eq('payment_status', 'paid')
                    .neq('status', 'cancelled')
                    .neq('status', 'refunded');

                  const totalSpent = (orderTotals || []).reduce((sum: number, o: any) => sum + (Number(o.total) || 0), 0);
                  
                  const { data: rules } = await supabaseAdminClient
                    .from('auto_coupon_rules')
                    .select('*')
                    .eq('is_active', true)
                    .order('spend_threshold', { ascending: true });

                  for (const rule of (rules || [])) {
                    if (totalSpent >= Number(rule.spend_threshold)) {
                      const { data: existingLog } = await supabaseAdminClient
                        .from('auto_coupon_sent_log')
                        .select('id')
                        .eq('rule_id', rule.id)
                        .ilike('user_email', guestEmail)
                        .limit(1);

                      if (existingLog && existingLog.length > 0) continue;

                      const newCode = 'AUTO' + Math.random().toString(16).slice(2, 8).toUpperCase();
                      const validUntil = new Date();
                      validUntil.setDate(validUntil.getDate() + (rule.valid_days || 30));

                      const { data: insertedCode } = await supabaseAdminClient
                        .from('discount_codes')
                        .insert({
                          code: newCode,
                          discount_type: rule.discount_type,
                          discount_value: rule.discount_value,
                          min_purchase: rule.min_purchase || 0,
                          max_uses: 1,
                          per_user_limit: 1,
                          valid_until: validUntil.toISOString(),
                          target_email: guestEmail,
                          personal_message: rule.personal_message || '',
                          is_active: true,
                        })
                        .select()
                        .single();

                      if (insertedCode) {
                        await supabaseAdminClient.from('auto_coupon_sent_log').insert({
                          rule_id: rule.id,
                          user_id: '00000000-0000-0000-0000-000000000000',
                          user_email: guestEmail,
                          discount_code_id: insertedCode.id,
                          total_spent: totalSpent,
                        });
                        generatedCoupons.push({ generated_code: newCode });
                      }
                    }
                  }
                }

                // Enviar email por cada cup√≥n generado
                for (const coupon of generatedCoupons) {
                  const { data: codeData } = await supabaseAdminClient
                    .from('discount_codes')
                    .select('*')
                    .eq('code', coupon.generated_code)
                    .single();

                  if (!codeData) continue;

                  const discountDisplay = codeData.discount_type === 'percentage'
                    ? `${codeData.discount_value}%`
                    : `‚Ç¨${Number(codeData.discount_value).toFixed(2)}`;

                  const couponHtml = generateDiscountCodeEmail({
                    customerName: 'Estimado/a cliente',
                    customerEmail: guestEmail,
                    code: codeData.code,
                    discountType: codeData.discount_type,
                    discountValue: Number(codeData.discount_value),
                    minPurchase: Number(codeData.min_purchase) || 0,
                    expirationDate: codeData.valid_until
                      ? new Date(codeData.valid_until).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })
                      : undefined,
                    personalMessage: codeData.personal_message ||
                      '¬°Gracias por confiar en BY ARENA! Como agradecimiento por tus compras, te regalamos este descuento exclusivo.',
                  });

                  const emailResult = await sendEmailWithGmail({
                    to: guestEmail,
                    subject: `üéÅ ¬°${discountDisplay} de descuento exclusivo para ti! - BY ARENA`,
                    html: couponHtml,
                  });

                  if (emailResult.success) {
                    await supabaseAdminClient
                      .from('discount_codes')
                      .update({ sent_at: new Date().toISOString() })
                      .eq('id', codeData.id);
                    console.log(`[AutoCoupon-Checkout] Email sent: ${codeData.code} ‚Üí ${guestEmail}`);
                  }
                }
              }
            } catch (couponError) {
              console.error('Error checking auto coupons:', couponError);
            }
            // ===== FIN CUPONES AUTOM√ÅTICOS =====
        }
      }
    }
  } catch (e) {
    console.error('Error verifying payment:', e);
    error = 'Error al verificar el pago';
  }
} else if (orderId) {
  // Fallback: verificar en la base de datos si ya est√° marcado como pagado
  const { data } = await supabaseAdminClient
    .from('orders')
    .select('*')
    .eq('id', orderId)
    .single();
  
  if (data?.status === 'paid' || data?.payment_status === 'paid') {
    paymentVerified = true;
    orderData = data;
  }
}
---

<BaseLayout title="Compra Exitosa | BY ARENA" description="Tu pedido ha sido procesado correctamente">
  <div class="min-h-screen bg-gradient-to-br from-green-50 via-cream to-arena-pale flex items-center justify-center px-4 py-12">
    <div class="max-w-2xl w-full bg-white rounded-lg border border-green-200 shadow-lg p-8 md:p-12 text-center">
      
      {paymentVerified ? (
        <>
          {/* Success Icon */}
          <div class="mb-8 flex justify-center">
            <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center">
              <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
          </div>

          {/* Title */}
          <h1 class="text-4xl md:text-5xl font-serif font-bold text-gray-900 mb-4">
            ¬°Compra Exitosa!
          </h1>

          {/* Message */}
          <p class="text-xl text-gray-600 mb-8">
            Gracias por tu compra. Tu pedido ha sido procesado correctamente.
          </p>

          {/* Order Details */}
          <div class="bg-arena-pale rounded-lg p-6 mb-8 text-left">
            <h3 class="font-semibold text-gray-900 mb-4">Detalles del Pedido</h3>
            <div class="space-y-2 text-gray-700">
              {orderId && (
                <p>
                  <strong>N√∫mero de Orden:</strong> <span class="font-mono">{orderId.slice(0, 8)}...</span>
                </p>
              )}
              <p>
                <strong>Estado:</strong> <span class="text-green-600 font-semibold">Pagado</span>
              </p>
              <p>
                <strong>Pr√≥ximo paso:</strong> Recibir√°s un email con los detalles de tu env√≠o
              </p>
            </div>
          </div>
        </>
      ) : (
        <>
          {/* Pending/Error Icon */}
          <div class="mb-8 flex justify-center">
            <div class="w-20 h-20 rounded-full bg-yellow-100 flex items-center justify-center">
              <svg class="w-10 h-10 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>

          <h1 class="text-3xl font-serif font-bold text-gray-900 mb-4">
            Verificando Pago...
          </h1>

          <p class="text-gray-600 mb-8">
            {error || 'No pudimos verificar el estado del pago. Si realizaste el pago, recibir√°s un email de confirmaci√≥n en breve.'}
          </p>
        </>
      )}

      {/* Actions */}
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/mis-pedidos"
          class="px-8 py-3 bg-arena text-white font-semibold rounded-lg hover:bg-arena-light transition-colors text-center"
        >
          Ver Mis Pedidos
        </a>
        <a
          href="/catalogo"
          class="px-8 py-3 border-2 border-arena text-arena font-semibold rounded-lg hover:bg-arena-pale transition-colors text-center"
        >
          Continuar Comprando
        </a>
      </div>

      {/* Support */}
      <div class="mt-12 pt-8 border-t border-arena-light">
        <p class="text-gray-600 mb-4">¬øTienes preguntas?</p>
        <a href="https://wa.me/34612345678" class="text-arena font-semibold hover:text-arena-light">
          Cont√°ctanos por WhatsApp
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Limpiar carrito al llegar a esta p√°gina
  import { clearCart } from '../stores/useCart';
  clearCart();
</script>
