---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReturnForm from '../../components/islands/ReturnForm';
import { supabaseAdminClient } from '../../lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/devoluciones');
}

// Obtener datos del pedido
const { data: order, error } = await supabaseAdminClient
  .from('orders')
  .select('id, total, guest_email, guest_first_name, guest_last_name, status, created_at')
  .eq('id', id)
  .single();

if (error || !order) {
  return Astro.redirect('/devoluciones?error=order-not-found');
}

// Solo permitir devoluciones de pedidos entregados o enviados
const allowedStatuses = ['delivered', 'shipped', 'paid', 'processing'];
if (!allowedStatuses.includes(order.status)) {
  return Astro.redirect('/devoluciones?error=invalid-status');
}

// Obtener items del pedido con info del producto
const { data: orderItems } = await supabaseAdminClient
  .from('order_items')
  .select('id, product_id, quantity, price, total, products(name, image_url)')
  .eq('order_id', id);

// Obtener devoluciones previas de items para saber qué ya se devolvió
const { data: existingReturns } = await supabaseAdminClient
  .from('returns')
  .select('id, status, return_items(order_item_id, quantity)')
  .eq('order_id', id)
  .neq('status', 'rejected')
  .neq('status', 'cancelled');

// Calcular items ya devueltos (sumar cantidades en devoluciones activas)
const returnedQuantities: Record<string, number> = {};
existingReturns?.forEach(ret => {
  (ret as any).return_items?.forEach((ri: any) => {
    returnedQuantities[ri.order_item_id] = (returnedQuantities[ri.order_item_id] || 0) + ri.quantity;
  });
});

const formattedItems = orderItems?.map(item => ({
  id: item.id,
  product_id: item.product_id,
  name: (item as any).products?.name || 'Producto',
  image_url: (item as any).products?.image_url || '',
  quantity: item.quantity,
  price: item.price,
  alreadyReturned: returnedQuantities[item.id] || 0,
})) || [];

const orderNumber = order.id.slice(0, 8).toUpperCase();
const customerEmail = order.guest_email || '';
---

<BaseLayout title="Solicitar Devolución | BY ARENA" description="Gestiona tu devolución">
  <div class="max-w-2xl mx-auto px-4 md:px-8 lg:px-12 py-16">
    <h1 class="text-4xl font-serif font-bold text-gray-900 mb-12">
      Solicitar Devolución
    </h1>

    <ReturnForm 
      client:load 
      orderId={order.id}
      orderNumber={orderNumber}
      orderTotal={order.total}
      customerEmail={customerEmail}
      orderItems={formattedItems}
    />
  </div>
</BaseLayout>
