---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ReturnForm from '../../components/islands/ReturnForm';
import { supabaseAdminClient } from '../../lib/supabase';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/devoluciones');
}

// Obtener datos del pedido
const { data: order, error } = await supabaseAdminClient
  .from('orders')
  .select('id, total, guest_email, guest_first_name, guest_last_name, status, created_at')
  .eq('id', id)
  .single();

if (error || !order) {
  return Astro.redirect('/devoluciones?error=order-not-found');
}

// Solo permitir devoluciones de pedidos entregados o enviados
const allowedStatuses = ['delivered', 'shipped', 'paid', 'processing'];
if (!allowedStatuses.includes(order.status)) {
  return Astro.redirect('/devoluciones?error=invalid-status');
}

const orderNumber = order.id.slice(0, 8).toUpperCase();
const customerEmail = order.guest_email || '';
---

<BaseLayout title="Solicitar Devolución | BY ARENA" description="Gestiona tu devolución">
  <div class="max-w-2xl mx-auto px-4 md:px-8 lg:px-12 py-16">
    <h1 class="text-4xl font-serif font-bold text-gray-900 mb-12">
      Solicitar Devolución
    </h1>

    <ReturnForm 
      client:load 
      orderId={order.id}
      orderNumber={orderNumber}
      orderTotal={order.total}
      customerEmail={customerEmail}
    />
  </div>
</BaseLayout>
